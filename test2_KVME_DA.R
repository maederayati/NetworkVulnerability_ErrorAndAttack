library(igraph)
library(gridExtra)
library(ggplot2)

#g <- make_ring(10)

n0<-1000
maxNumberOfAttacks<-10
attackSeq<-seq(2,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)
V(g0)$name <- V(g0)


findAttack<-function(g,k){
    
    a1<-vector()
    z<-1
    dg<-degree(g)
    od<-sort(unique(dg),decreasing = T)
    a1<-names(subset(dg,dg==od[z]))
    
    while(length(a1)<k){
        z<-z+1
        a1<-c(a1,names(subset(dg,dg==od[z])))
    }
    
    if(length(a1)>k){
        a1<-a1[1:k]
    }

    a1
}

findEfficiency<-function(g){
    dtr<-distance_table(g,directed = F)$res
    e<-sum(dtr*(1/(1:length(dtr))))/(vcount(g)*(vcount(g)-1))
    e
}

findVulnerability<-function(g,at){
    
    g2<-delete.vertices(g,at)
    
   (1-(findEfficiency(g2)/findEfficiency(g)))
}

getCombinations<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-subset(bts, names(bts) %in% m)
    combinations<-combn(bts_sub,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
}

getNodes<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-names(subset(bts, names(bts) %in% m))
}


###################################

vulAfter<-vector()
efAfter<-vector()
vulBefore<-vector()
efBefore<-vector()
linksAdded<-vector()


#attackSeq
for(k in attackSeq){
    
    at0<-findAttack(g0,k)
    gAt0<-delete.vertices(g0,at0)
    Vul0<-findVulnerability(g0,at0)
    efAt0<-findEfficiency(gAt0)
    vulBefore<-c(vulBefore,findVulnerability(g0,at0))
    efBefore<-c(efBefore,findEfficiency(gAt0))
    
    
    gAt<-gAt0
    g<-g0
    Vul<-Vul0
    efAt<-efAt0
    
    

    t<-0
    Flag<-1

    
    while(Flag){
        t<-t+1
        print(t)
        
        at<-findAttack(g,k)
        gAt<-delete.vertices(g,at)
        
        if(is.connected(gAt))
            Flag<-0
        
        else{
            combinations<-getCombinations(gAt)
            comFlag<-sapply(combinations,function(x){
                    n<-names(x)
                    gTmp<-g+edge(n[1],n[2])
                    at<-findAttack(gTmp,k)
                    if(findVulnerability(gTmp,at)>Vul0)
                        F
                    else
                        T
            })
           # print("after comflag")
            if(sum(comFlag)>0){
                
                newCom<-combinations[comFlag]
                benefit<-sapply(newCom,function(x){
                        n<-names(x)
                        gTmp<-g+edge(n[1],n[2])
                        at<-findAttack(gTmp,k)
                        gTmp2<-delete.vertices(gTmp,at)
                        findEfficiency(gTmp2)-efAt
                })
               # print("after benefit")
                
                if(length(which(benefit>0))==0)    
                    Flag<-0
                else{
                    selectedCom<-newCom[[which(benefit==max(benefit))[1]]]
                    n<-names(selectedCom)
                    g<-g+edge(n[1],n[2])
                    at<-findAttack(g,k)
                    Vul<-findVulnerability(g,at)
                    gAt<-delete.vertices(g,at)
                    efAt<-findEfficiency(gAt)
                }
              
            }
            
            else
                Flag<-0
        }
        
    }

    vulAfter<-c(vulAfter,Vul)
    efAfter<-c(efAfter,efAt)
    linksAdded<-c(linksAdded,t)
    print(k)
    
}


###################################plot result###########################

#
df<-cbind.data.frame(attackSeq,efAfter,efBefore,vulAfter,vulBefore,linksAdded)
names(df)<-c("numberOfAttacks","efAfter","efBefore","vulAfter","vulBefore","linksAdded")
######vulGraph


vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = vulAfter, colour="After Adding Wires")) + 
  geom_line(aes(y = vulBefore, colour = "Before Adding Wires")) + 
  ylab(label="Vulnerability") + 
  xlab("Number of Attacks")+
  scale_colour_manual(values=c("blue", "red"))+
  labs(title=paste("for",n0,"nodes - Not increasing Vulnerability & maximizing efficiency"))

efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = efAfter, colour="After Adding Wires")) + 
  geom_line(aes(y = efBefore, colour = "Before Adding Wires")) + 
  ylab(label="Efficiency After Attack") + 
  xlab("Number of Attacks")+
  scale_colour_manual(values=c("blue", "red"))+
  labs(title=paste("for",n0,"nodes - Not increasing Vulnerability & maximizing efficiency"))



linkNumPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = linksAdded)) + 
  ylab(label="Number of Links Added") + 
  xlab("Number of Attacks")+
  labs(title=paste("for",n0,"nodes"))


st1<-paste0("Ef&Vul_KVME_",n0,".png")
png(st1)
print(grid.arrange(vulPlot, efPlot, ncol=1, nrow =2))
dev.off()


st2<-paste0("LinkNum_KVME_",n0,".png")
png(st2)
print(linkNumPlot)
dev.off()
