library(igraph)
library(gridExtra)
library(ggplot2)



n0<-100
maxNumberOfAttacks<-10
attackSeq<-seq(0,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)
V(g0)$name <-V(g0)

#gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g0),type = "gnm")
#V(gr)$name <-V(gr)

lengthOption<-"FL"
algorithm<-"MV"
attackMethod<-"BA"
Linklimit<-20

limitSeq<-seq(10,50,by=2)



#############functions###############
findAttack<-function(g,k){
    
    if(k!=0){
        a1<-vector()
        z<-1
        bts<-betweenness(g,directed = F)
        od<-sort(unique(bts),decreasing = T)
        a1<-names(subset(bts,bts==od[z]))
        
        while(length(a1)<k){
            z<-z+1
            a1<-c(a1,names(subset(bts,bts==od[z])))
        }
        
        if(length(a1)>k){
            a1<-a1[1:k]
        }
        
        a1
    }
    else 
        NA
}

findEfficiency<-function(g){
    dtr<-distance_table(g,directed = F)$res
    e<-2*sum(dtr*(1/(1:length(dtr))))/(vcount(g)*(vcount(g)-1))
    e
}


findVulnerability<-function(g,at){
    
    if(is.na(at[1]))
        0
    
    else{
        g2<-graphAfterAttack(g,at)
        
       (1-(findEfficiency(g2)/findEfficiency(g)))
    }
}

getCombinations<-function(g){
    bts<-sort(betweenness(g,directed = F),decreasing = T)
    #combinations<-list()
    #n<-names(bts)
    combinations<-combn(bts,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
    
}

graphAfterAttack<-function(g,at){
    if(is.na(at[1]))
        g
    else{
        gTemp<-delete.vertices(g,at)
        gTemp2<-add.vertices(gTemp,length(at),name=at)
    }
        
}

findRobustness<-function(g){
    
    efs<-vector()
    l<-vcount(g)
    gTemp<-g
    for(i in 1:(l-2)){
        at<-findAttack(gTemp,1)
        gTemp<-graphAfterAttack(gTemp,at)
        efs<-c(efs,findEfficiency(gTemp))
        
    }
  
    efs
    #sum(vuls*((l-2):1))/sum(1:(l-2))
    #vuls[10]
}

#######################################


for(u in limitSeq){
    
   
    
    g<-g0
    i<-1
    Flag2<-1
    c<-getCombinations(g0)
    while(i<u && Flag2){
        print(i)
    
        r0<-findRobustness(g)
        l<-length(c)
        m<-1
        r1<-r0
        Flag<-1
        while(m<=l && Flag){
            name<-names(c[[m]])
            if(g[name[1],name[2]]){
                m<-m+1
            }
            else{
                r1<-findRobustness(g+edge(name[1],name[2]))
                if((r1+0.1)<r0)
                    Flag<-0
                else
                    m<-m+1
            }
        
        }
        if(m>l)
            Flag2<-0
        else{
            g<-g+edge(name[1],name[2])
            i<-i+1
        }
            
           
    }
    
    
    ###################################
    
    vulAfter<-vector()
    efAfter<-vector()
    vulBefore<-vector()
    efBefore<-vector()
    linksAdded<-vector()
    
    vulgr<-vector()
    efgr<-vector()
    
    for(k in attackSeq){
        
        at0<-findAttack(g0,k)
        gAt0<-graphAfterAttack(g0,at0)
        Vul0<-findVulnerability(g0,at0)
        efAt0<-findEfficiency(gAt0)
        vulBefore<-c(vulBefore,findVulnerability(g0,at0))
        efBefore<-c(efBefore,findEfficiency(gAt0))
        
       
            
        at<-findAttack(g,k)
        Vul<-findVulnerability(g,at)
        gAt<-graphAfterAttack(g,at)
        efAt<-findEfficiency(gAt)
        
        ##############
        set.seed(123)
        gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g),type = "gnm")
        V(gr)$name <-V(gr)
        atr<-findAttack(gr,k)
        gAtr<-graphAfterAttack(gr,atr)
        vulgr<-c(vulgr,findVulnerability(gr,atr))
        efgr<-c(efgr,findEfficiency(gAtr))
        ####################
        
        vulAfter<-c(vulAfter,Vul)
        efAfter<-c(efAfter,efAt)
        linksAdded<-c(linksAdded,i)
        print(k)
        
    }
    
    
    #
    ###################################plot result###########################
    df<-cbind.data.frame(attackSeq,efAfter,efBefore,vulAfter,vulBefore,linksAdded,vulgr,efgr)
    names(df)<-c("numberOfAttacks","efAfter","efBefore","vulAfter","vulBefore","linksAdded",
                 "vulgr","efgr")
    
    
    
    vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = vulAfter, colour="After Add")) + 
        geom_line(aes(y = vulBefore, colour = "Before Add")) +
        geom_line(aes(y = vulgr, colour = "Random graph same size as added")) + 
        ylab(label="Vulnerability to Attck") + 
        xlab("Number of Attacks")+
        scale_colour_manual(values=c("blue", "red","green"))+
        scale_x_continuous(breaks=attackSeq)
    
    efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = efAfter, colour="After Add")) + 
        geom_line(aes(y = efBefore, colour = "Before Add")) + 
        geom_line(aes(y = efgr, colour = "Random graph same size as added"))+
        ylab(label="Efficiency After Attack") + 
        xlab("Number of Attacks")+
        scale_colour_manual(values=c("blue", "red","green"))+
        scale_x_continuous(breaks=attackSeq)
    
    
    linkNumPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = linksAdded)) + 
        ylab(label="Number of Links Added") + 
        xlab("Number of Attacks")+
        scale_x_continuous(breaks=attackSeq)
    
    
    st1<-paste0("",algorithm,"_",attackMethod,"_",lengthOption,"_",n0,"_AddedSize_fixedL",u,".png")
    png(st1)
    print(grid.arrange(vulPlot, efPlot,linkNumPlot ,ncol=1, nrow =3))
    dev.off()
    
    
}