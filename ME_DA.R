library(igraph)
library(gridExtra)
library(ggplot2)



n0<-100
maxNumberOfAttacks<-10
attackSeq<-seq(0,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)
V(g0)$name <-V(g0)

#gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g0),type = "gnm")
#V(gr)$name <-V(gr)

lengthOption<-"FL"
algorithm<-"ME"
attackMethod<-"DA"
Linklimit<-20



findAttack<-function(g,k){
    
    if(k!=0){
        a1<-vector()
        z<-1
        dg<-degree(g)
        od<-sort(unique(dg),decreasing = T)
        a1<-names(subset(dg,dg==od[z]))
        
        while(length(a1)<k){
            z<-z+1
            a1<-c(a1,names(subset(dg,dg==od[z])))
        }
        
        if(length(a1)>k)
            a1<-a1[1:k]
    
        a1
    }
    else 
        NA
}

findEfficiency<-function(g){
    dtr<-distance_table(g,directed = F)$res
    e<-2*sum(dtr*(1/(1:length(dtr))))/(vcount(g)*(vcount(g)-1))
    e
}

findVulnerability<-function(g,at){
    
    if(is.na(at[1]))
        0
    
    else{
        g2<-delete.vertices(g,at)
        
       (1-(findEfficiency(g2)/findEfficiency(g)))
    }
}

getCombinations<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-subset(bts, names(bts) %in% m)
    combinations<-combn(bts_sub,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
}

graphAfterAttack<-function(g,at){
    if(is.na(at[1]))
        g
    else
        delete.vertices(g,at)
}


###################################

vulAfter<-vector()
efAfter<-vector()
vulBefore<-vector()
efBefore<-vector()
linksAdded<-vector()

vulgr<-vector()
efgr<-vector()

for(k in attackSeq){
    
    at0<-findAttack(g0,k)
    gAt0<-graphAfterAttack(g0,at0)
    Vul0<-findVulnerability(g0,at0)
    efAt0<-findEfficiency(gAt0)
    vulBefore<-c(vulBefore,findVulnerability(g0,at0))
    efBefore<-c(efBefore,findEfficiency(gAt0))
    
    #atr<-findAttack(gr,k)
    #gAtr<-graphAfterAttack(gr,atr)
    #vulgr<-c(vulgr,findVulnerability(gr,atr))
    #efgr<-c(efgr,findEfficiency(gAtr))
        
    gAt<-gAt0
    g<-g0
    Vul<-Vul0
    efAt<-efAt0
        
    t<-0
    Flag<-1
    
    while(Flag && t<Linklimit){
        t<-t+1
        print(t)
            
        at<-findAttack(g,k)
        gAt<-graphAfterAttack(g,at)
    
        if(is.connected(gAt))
                Flag<-0
            
        else{
            combinations<-getCombinations(gAt)
            benefit<-sapply(combinations,function(x){
                n<-names(x)
                gTmp<-g+edge(n[1],n[2])
                at<-findAttack(gTmp,k)
                gTmp2<-graphAfterAttack(gTmp,at)
                findEfficiency(gTmp2)-efAt
            })
                  
                    
            if(length(which(benefit>0))==0)    
                Flag<-0
            
            else{
                selectedCom<-combinations[[which(benefit==max(benefit))[1]]]
                n<-names(selectedCom)
                g<-g+edge(n[1],n[2])
                at<-findAttack(g,k)
                Vul<-findVulnerability(g,at)
                gAt<-graphAfterAttack(g,at)
                efAt<-findEfficiency(gAt)
            }
    
        }
    }
    
    ######
    set.seed(123)
    gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g),type = "gnm")
    V(gr)$name <-V(gr)
    atr<-findAttack(gr,k)
    gAtr<-graphAfterAttack(gr,atr)
    vulgr<-c(vulgr,findVulnerability(gr,atr))
    efgr<-c(efgr,findEfficiency(gAtr))
    #######
    
    vulAfter<-c(vulAfter,Vul)
    efAfter<-c(efAfter,efAt)
    linksAdded<-c(linksAdded,t)
    print(k)
    
}


###################################plot result###########################

#
df<-cbind.data.frame(attackSeq,efAfter,efBefore,vulAfter,vulBefore,linksAdded,vulgr,efgr)
names(df)<-c("numberOfAttacks","efAfter","efBefore","vulAfter","vulBefore","linksAdded",
             "vulgr","efgr")



vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
    geom_line(aes(y = vulAfter, colour="After Add")) + 
    geom_line(aes(y = vulBefore, colour = "Before Add")) +
    geom_line(aes(y = vulgr, colour = "Random graph same size as added")) + 
    ylab(label="Vulnerability to Attck") + 
    xlab("Number of Attacks")+
    scale_colour_manual(values=c("blue", "red","green"))+
    scale_x_continuous(breaks=attackSeq)

efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
    geom_line(aes(y = efAfter, colour="After Add")) + 
    geom_line(aes(y = efBefore, colour = "Before Add")) + 
    geom_line(aes(y = efgr, colour = "Random graph same size as added"))+
    ylab(label="Efficiency After Attack") + 
    xlab("Number of Attacks")+
    scale_colour_manual(values=c("blue", "red","green"))+
    scale_x_continuous(breaks=attackSeq)


linkNumPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
    geom_line(aes(y = linksAdded)) + 
    ylab(label="Number of Links Added") + 
    xlab("Number of Attacks")+
    scale_x_continuous(breaks=attackSeq)


st1<-paste0("graphs/",algorithm,"_",attackMethod,"_",lengthOption,"_",n0,"_AddedSize.png")
png(st1)
print(grid.arrange(vulPlot, efPlot,linkNumPlot ,ncol=1, nrow =3))
dev.off()

