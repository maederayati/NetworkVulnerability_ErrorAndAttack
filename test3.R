library(igraph)
library(gridExtra)
library(ggplot2)



n0<-100
maxNumberOfAttacks<-10
attackSeq<-seq(0,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)
V(g0)$name <-V(g0)




findAttack<-function(g,k){
    
    if(k!=0){
        a1<-vector()
        z<-1
        bts<-betweenness(g,directed = F)
        od<-sort(unique(bts),decreasing = T)
        a1<-names(subset(bts,bts==od[z]))
        
        while(length(a1)<k){
            z<-z+1
            a1<-c(a1,names(subset(bts,bts==od[z])))
        }
        
        if(length(a1)>k){
            a1<-a1[1:k]
        }
        
        a1
    }
    else 
        NA
}

findEfficiency<-function(g){
    dtr<-distance_table(g,directed = F)$res
    e<-2*sum(dtr*(1/(1:length(dtr))))/(vcount(g)*(vcount(g)-1))
    e
}

findVulnerability<-function(g,at){
    
    if(is.na(at[1]))
        0
    
    else{
        g2<-delete.vertices(g,at)
        
        (1-(findEfficiency(g2)/findEfficiency(g)))
    }
}

getCombinations<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-subset(bts, names(bts) %in% m)
    combinations<-combn(bts_sub,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
}

graphAfterAttack<-function(g,at){
    if(is.na(at[1]))
        g
    else
        delete.vertices(g,at)
}


k<-20


at0<-findAttack(g0,k)
gAt0<-graphAfterAttack(g0,at0)
Vul0<-findVulnerability(g0,at0)
efAt0<-findEfficiency(gAt0)



gAt<-gAt0
g<-g0
Vul<-Vul0
efAt<-efAt0

t<-0
Flag<-1

while(Flag){
    t<-t+1
    print(t)
    
    at<-findAttack(g,k)
    gAt<-graphAfterAttack(g,at)
    
    if(is.connected(gAt))
        Flag<-0
    
    else{
        combinations<-getCombinations(gAt)
        benefit<-sapply(combinations,function(x){
            n<-names(x)
            gTmp<-g+edge(n[1],n[2])
            at<-findAttack(gTmp,k)
            gTmp2<-graphAfterAttack(gTmp,at)
            findEfficiency(gTmp2)-efAt
        })
        
        
        if(length(which(benefit>0))==0)    
            Flag<-0
        
        else{
            selectedCom<-combinations[[which(benefit==max(benefit))[1]]]
            n<-names(selectedCom)
            g<-g+edge(n[1],n[2])
            at<-findAttack(g,k)
            Vul<-findVulnerability(g,at)
            gAt<-graphAfterAttack(g,at)
            efAt<-findEfficiency(gAt)
        }
        
    }
}


#for g0

j<-19

vul1<-vector()
ef1<-vector()
for(i in 0:j){
    at1<-findAttack(g0,i)
    at2<-findAttack(g0,i+1)
    gafter<-findEfficiency(graphAfterAttack(g0,at2))
    gbefore<-findEfficiency(graphAfterAttack(g0,at1))  
    
    ef1<-c(ef1, gbefore)
    vul1<-c(vul1, (gbefore-gafter)/gbefore)
    
    
    
}

df<-cbind.data.frame(1:j,vul1)



vul2<-vector()
ef2<-vector()
for(i in 0:j){
    at1<-findAttack(g,i)
    at2<-findAttack(g,i+1)
    gafter<-findEfficiency(graphAfterAttack(g,at2))
    ef2<-c(ef2, gbefore)
    gbefore<-findEfficiency(graphAfterAttack(g,at1))  
    
    
    vul2<-c(vul2, (gbefore-gafter)/gbefore)

}

df<-cbind.data.frame(0:j,vul1,vul2,ef1,ef2)
names(df)<-c("numberOfAttacks","g0","g","ef0","ef")


vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
    geom_line(aes(y = g0, colour="before Add")) + 
    geom_line(aes(y = g, colour = "after Add")) +
    ylab(label="Vulnerability") + 
    xlab("Number of Attacks")+
    scale_colour_manual(values=c("red", "blue"))+
    scale_x_continuous(breaks=0:j)

efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
    geom_line(aes(y = ef0, colour="before Add")) + 
    geom_line(aes(y = ef, colour = "after Add")) +
    ylab(label="efficiency") + 
    xlab("Number of Attacks")+
    scale_colour_manual(values=c("red", "blue"))+
    scale_x_continuous(breaks=0:j)


