library(igraph)
library(gridExtra)
library(ggplot2)



n0<-100
maxNumberOfAttacks<-10
attackSeq<-seq(0,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)
V(g0)$name <-V(g0)

#gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g0),type = "gnm")
#V(gr)$name <-V(gr)

lengthOption<-"FL"
algorithm<-"MV"
attackMethod<-"BA"
Linklimit<-20

limitSeq<-seq(10,50,by=2)



findAttack<-function(g,k){
        
        if(k!=0){
            a1<-vector()
            z<-1
            bts<-betweenness(g,directed = F)
            od<-sort(unique(bts),decreasing = T)
            a1<-names(subset(bts,bts==od[z]))
            
            while(length(a1)<k){
                z<-z+1
                a1<-c(a1,names(subset(bts,bts==od[z])))
            }
            
            if(length(a1)>k){
                a1<-a1[1:k]
            }
            
            a1
        }
        else 
            NA
 }
 
graphAfterAttackWith<-function(g,at){
    if(is.na(at[1]))
        g
    else{
        gTemp<-delete.vertices(g,at)
        gTemp2<-add.vertices(gTemp,length(at),name=at)
        gTemp2
    }
        
}


graphAfterAttackWithout<-function(g,at){
    if(is.na(at[1]))
        g
    else{
        gTemp<-delete.vertices(g,at)
        gTemp
    }
        
}
    
findEfficiency<-function(g,at){
    gTemp<-graphAfterAttackWith(g,at)
    dtr<-distance_table(gTemp,directed = F)$res
    e<-2*sum(dtr*(1/(1:length(dtr))))/(vcount(gTemp)*(vcount(gTemp)-1))
    e
}
    
findVulnerability<-function(g,at){
    (1-(findEfficiency(g,at)/findEfficiency(g,NA)))
}
    
getCombinations<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-subset(bts, names(bts) %in% m)
    combinations<-combn(bts_sub,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
}




findRobustness<-function(g){
    
    vuls<-vector()
    l<-vcount(g)
    gTemp<-g
    for(i in 1:(l-2)){
        at<-findAttack(g,i)
        vuls<-c(vuls,findVulnerability(g,at))
    }
    mean(vuls)
}
  
    

for(u in limitSeq){
    


    vulAfter<-vector()
    efAfter<-vector()
    vulBefore<-vector()
    efBefore<-vector()
    linksAdded<-vector()
    vulgr<-vector()
    efgr<-vector()
    
    

        

        
       
    g<-g0

    
    
    
    ##############
    set.seed(123)
    gr<-erdos.renyi.game(n=n0,p.or.m = ecount(g),type = "gnm")
    V(gr)$name <-V(gr)
   
    
    
            
    t<-0
    Flag<-1
    k<-1    

        
    while(k<n0 && t<u ){
            
            print(t)
            
            at0<-findAttack(g0,k)
            vul0<-findVulnerability(g0,at0)
            
            at<-findAttack(g,k)
            gAt<-graphAfterAttackWithout(g,at)
            
            if(!is.connected(gAt)){
                combinations<-getCombinations(gAt)
                

                benefit<-sapply(combinations[1:10],function(x){
                    n<-names(x)
                    gTmp<-g+edge(n[1],n[2])
                    at<-findAttack(gTmp,k)
                    -findRobustness(gTmp)
                    #vul0-findVulnerability(gTmp,at)
                            
                })
                print("afterBenefit")
                              
                selectedCom<-combinations[[which(benefit==max(benefit))[1]]]
                n<-names(selectedCom)
                g<-g+edge(n[1],n[2])
                t<-t+1
            }
            
            k<-k+1
            
                
    }
        
            
    for(k in attackSeq){   
        
        at0<-findAttack(g0,k)
        Vul0<-findVulnerability(g0,at0)
        vulBefore<-c(vulBefore,findVulnerability(g0,at0))
        efBefore<-c(efBefore,findEfficiency(g0,at0))
        ##################
        atr<-findAttack(gr,k)
        vulgr<-c(vulgr,findVulnerability(gr,atr))
        efgr<-c(efgr,findEfficiency(gr,atr))
        ####################
        at<-findAttack(g,k)
        vulAfter<-c(vulAfter,findVulnerability(g,at))
        efAfter<-c(efAfter,findEfficiency(g,at))
        linksAdded<-c(linksAdded,t)
        print(k)
        
    }
    
    
    #
    ###################################plot result###########################
    df<-cbind.data.frame(attackSeq,efAfter,efBefore,vulAfter,vulBefore,linksAdded,vulgr,efgr)
    names(df)<-c("numberOfAttacks","efAfter","efBefore","vulAfter","vulBefore","linksAdded",
                 "vulgr","efgr")
    
    
    
    vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = vulAfter, colour="After Add")) + 
        geom_line(aes(y = vulBefore, colour = "Before Add")) +
        geom_line(aes(y = vulgr, colour = "Random graph same size as added")) + 
        ylab(label="Vulnerability to Attck") + 
        xlab("Number of Attacks")+
        scale_colour_manual(values=c("blue", "red","green"))+
        scale_x_continuous(breaks=attackSeq)
    
    efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = efAfter, colour="After Add")) + 
        geom_line(aes(y = efBefore, colour = "Before Add")) + 
        geom_line(aes(y = efgr, colour = "Random graph same size as added"))+
        ylab(label="Efficiency After Attack") + 
        xlab("Number of Attacks")+
        scale_colour_manual(values=c("blue", "red","green"))+
        scale_x_continuous(breaks=attackSeq)
    
    
    linkNumPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
        geom_line(aes(y = linksAdded)) + 
        ylab(label="Number of Links Added") + 
        xlab("Number of Attacks")+
        scale_x_continuous(breaks=attackSeq)
    
    
    st1<-paste0("",algorithm,"_",attackMethod,"_",lengthOption,"_",n0,"_AddedSize_fixedL",u,".png")
    png(st1)
    print(grid.arrange(vulPlot, efPlot,linkNumPlot ,ncol=1, nrow =3))
    dev.off()
    
    
}