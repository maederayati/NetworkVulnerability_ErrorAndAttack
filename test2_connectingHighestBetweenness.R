library(igraph)
library(gridExtra)
library(ggplot2)

#g <- make_ring(10)

n0<-1000
maxNumberOfAttacks<-10
attackSeq<-seq(2,maxNumberOfAttacks,by=2)
set.seed(123)
g0 <- sample_pa(n0,directed = F)

V(g0)$name <- V(g0)
dtr<-distance_table(g0,directed = F)$res
Eglob0<-sum(dtr*(1/(1:length(dtr))))/(n0*(n0-1))

Eglob<-Eglob0
Vulnerability<-0


findAttack<-function(g,k){
    
    a1<-vector()
    z<-1
    od<-sort(unique(degree(g)),decreasing = T)
    a1<-which(degree(g)==od[z])
    
    while(length(a1)<k){
        z<-z+1
        a1<-c(a1,which(degree(g)==od[z]))
    }
    
    if(length(a1)>k){
        a1<-a1[1:k]
    }

    a1
}

findEfficiency<-function(g){
    dtr<-distance_table(g,directed = F)$res
    e<-sum(dtr*(1/(1:length(dtr))))/((vcount(g)-k)*(vcount(g)-k-1))
    e
}

findVulnerability<-function(g,at){
    
    g2<-delete.vertices(g,at)
    
   (1-(findEfficiency(g2)/findEfficiency(g)))
}

getCombinations<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-subset(bts, names(bts) %in% m)
    combinations<-combn(bts_sub,2,simplify = F)
    a<-sapply(combinations,sum)
    combinations[order(-a)]
}

getNodes<-function(g){
    cl<-clusters(g)
    bts<-betweenness(g,directed = F)
    m<-vector()
    for(i in 1:cl$no){
        namesOfcl<-names(cl$membership[which(cl$membership==i)])
        sub<-subset(bts, names(bts) %in%namesOfcl)
        m<-c(m,names(sub[which(sub==max(sub))])[1])
    }
    bts_sub<-names(subset(bts, names(bts) %in% m))
}


###################################

vulAfter<-vector()
efAfter<-vector()
vulBefore<-vector()
efBefore<-vector()
linksAdded<-vector()



for(k in attackSeq){
    
    at0<-findAttack(g0,k)
    gAt0<-delete.vertices(g0,at0)
    Vul0<-findVulnerability(g0,at0)
    efAtAfter0<-findEfficiency(gAt0)
    
    
    vulBefore<-c(vulBefore,findVulnerability(g0,at0))
    efBefore<-c(efBefore,findEfficiency(gAt0))
    
    gAt<-gAt0
    g<-g0
    Vul<-Vul0
    efAtAfter<-findEfficiency(gAt)
    

    t<-0
    
    Flag<-1
    gAtAfter<-gAt
    
    while(Flag && t<20){
        t<-t+1
        print(t)

        
        if(is.connected(gAt))
            Flag<-0
        else{
            combinations<-getCombinations(gAt)
            counter<-1
            counterFlag<-1
            while(counterFlag && counter<length(combinations)){
                n<-names(combinations[[counter]])
                gTmp<-g+edge(n[1],n[2])
                at<-findAttack(gTmp,k)
                
                if(n[1]%in%names(at) || n[2]%in%names(at))
                        counter<-counter+1
                else
                    counterFlag<-0
            }
            if(!counterFlag){
                n<-names(combinations[[counter]])
                g<-g+edge(n[1],n[2])
                at<-findAttack(g,k)
                gAt<-delete.vertices(g,at)
                efAtAfter<-findEfficiency(gAt)
           
            }
            else
                Flag<-0
              
        }
        
    }
    at<-findAttack(g,k)
    vulAfter<-c(vulAfter,findVulnerability(g,at))
    efAfter<-c(efAfter,findEfficiency(g))
    linksAdded<-c(linksAdded,t)
    print(k)
    
}


###################################plot result###########################

#
df<-cbind.data.frame(attackSeq,efAfter,efBefore,vulAfter,vulBefore,linksAdded)
names(df)<-c("numberOfAttacks","efAfter","efBefore","vulAfter","vulBefore","linksAdded")
######vulGraph


vulPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = vulAfter, colour="After Adding Wires")) + 
  geom_line(aes(y = vulBefore, colour = "Before Adding Wires")) + 
  ylab(label="Vulnerability") + 
  xlab("Number of Attacks")+
  scale_colour_manual(values=c("blue", "red"))+
  labs(title=paste("for",n0,"nodes - fixed length max(L)=20 Connecting highest betweenness"))

efPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = efAfter, colour="After Adding Wires")) + 
  geom_line(aes(y = efBefore, colour = "Before Adding Wires")) + 
  ylab(label="Efficiency") + 
  xlab("Number of Attacks")+
  scale_colour_manual(values=c("blue", "red"))+
  labs(title=paste("for",n0,"nodes - fixed length max(L)=20 Connecting highest betweenness"))



linkNumPlot<-ggplot(df, aes(x = numberOfAttacks)) + 
  geom_line(aes(y = linksAdded)) + 
  ylab(label="Number of Links Added") + 
  xlab("Number of Attacks")+
  labs(title=paste("for",n0,"nodes - max(L)=20"))


st1<-paste0("Ef&Vul",n0,"fixedL20.png")
png(st1)
print(grid.arrange(vulPlot, efPlot, ncol=1, nrow =2))
dev.off()


st2<-paste0("resultLinkNum",n0,"fixedL20.png")
png(st2)
print(linkNumPlot)
dev.off()

############################################
